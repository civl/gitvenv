<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBOC Penalty Downloader</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="text"], button { padding: 8px; width: 100%; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #log-container { margin-top: 20px; background: #f5f5f5; border: 1px solid #ccc; height: 400px; padding: 10px; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 2px 0; border-bottom: 1px solid #eee; }
        .success { color: green; }
        .error { color: red; }
        .info { color: #333; }
        .progress-bar { width: 100%; background-color: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background-color: #28a745; width: 0%; transition: width 0.3s ease; text-align: center; color: white; line-height: 20px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>PBOC Administrative Penalty Downloader</h1>
    
    <div class="container">
        <div class="form-group">
            <label for="province">Select Province:</label>
            <select id="province">
                {% for p in provinces %}
                    <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>
        
        <button id="start-btn" onclick="startDownload()">Start Download</button>
        
        <div style="margin-top: 20px;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill">0%</div>
            </div>
            <div id="status-text">Ready</div>
        </div>
        <div id="log-container">
            <div style="display: flex; height: 100%; gap: 10px;">
                <div style="flex: 1; overflow-y: auto;">
                    <div class="log-entry info">下载成功文件</div>
                    <div id="success-list"></div>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <div class="log-entry info">下载失败文件</div>
                    <div id="fail-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource;

        function startDownload() {
            const province = document.getElementById('province').value;
            const btn = document.getElementById('start-btn');
            const successList = document.getElementById('success-list');
            const failList = document.getElementById('fail-list');
            
            btn.disabled = true;
            btn.innerText = "Running...";
            successList.innerHTML = '';
            failList.innerHTML = '';
            
            // Start the process via fetch
            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ province: province })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    connectEventSource();
                } else {
                    alert('Failed to start: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = "Start Download";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting download');
                btn.disabled = false;
                btn.innerText = "Start Download";
            });
        }

        function connectEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/stream');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'log') {
                    if (data.level === 'success') {
                        const item = document.createElement('div');
                        item.className = 'log-entry success';
                        item.textContent = data.message;
                        const successList = document.getElementById('success-list');
                        successList.appendChild(item);
                        successList.scrollTop = successList.scrollHeight;
                    } else if (data.level === 'error') {
                        const item = document.createElement('div');
                        item.className = 'log-entry error';
                        item.textContent = data.message;
                        const failList = document.getElementById('fail-list');
                        failList.appendChild(item);
                        failList.scrollTop = failList.scrollHeight;
                    }
                } else if (data.type === 'progress') {
                    const percent = Math.round((data.current / data.total) * 100);
                    const fill = document.getElementById('progress-fill');
                    fill.style.width = percent + '%';
                    fill.textContent = percent + '%';
                    document.getElementById('status-text').textContent = `Processed: ${data.current} / ${data.total} (Success: ${data.success}, Fail: ${data.fail})`;
                    
                    if (data.current >= data.total && data.total > 0) {
                        document.getElementById('start-btn').disabled = false;
                        document.getElementById('start-btn').innerText = "Start Download";
                        eventSource.close();
                    }
                } else if (data.type === 'done') {
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('start-btn').innerText = "Start Download";
                    eventSource.close();
                    const div = document.createElement('div');
                    div.className = 'log-entry info';
                    div.textContent = "=== Process Completed ===";
                    document.getElementById('log-container').appendChild(div);
                }
            };
            
            eventSource.onerror = function() {
                console.log("EventSource failed.");
                eventSource.close();
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerText = "Start Download";
            };
        }
    </script>
</body>
</html>
