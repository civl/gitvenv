<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBOC 支付机构爬虫控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress { height: 25px; margin-bottom: 10px; }
        .log-box { height: 200px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 0.9em; }
        .result-table { font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">PBOC 支付机构爬虫控制台</h2>
        
        <div class="card mb-4">
            <div class="card-header">
                配置与启动
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>数据库配置</h5>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">Host</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" name="host" value="{{ config.host }}">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">Port</label>
                                <div class="col-sm-8">
                                    <input type="number" class="form-control" name="port" value="{{ config.port }}">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">User</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" name="user" value="{{ config.user }}">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">Password</label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" name="password" value="{{ config.password }}">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">Schema</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" name="schema" value="{{ config.schema }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>运行配置</h5>
                            <div class="mb-3 row">
                                <label class="col-sm-4 col-form-label">最大线程数</label>
                                <div class="col-sm-8">
                                    <input type="number" class="form-control" id="maxWorkers" value="3" min="1" max="10">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="button" class="btn btn-primary w-100" id="startBtn" onclick="startScraper()">开始抓取</button>
                            </div>
                            <div class="mt-3">
                                <div class="alert alert-info" id="statusMessage">就绪</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                运行进度
            </div>
            <div class="card-body">
                <h6>已获许可机构</h6>
                <div class="progress">
                    <div class="progress-bar" id="progRegistered" role="progressbar" style="width: 0%">0%</div>
                </div>
                <small id="textRegistered" class="text-muted d-block mb-2">等待开始...</small>

                <h6>已注销许可机构</h6>
                <div class="progress">
                    <div class="progress-bar bg-warning" id="progUnregistered" role="progressbar" style="width: 0%">0%</div>
                </div>
                <small id="textUnregistered" class="text-muted d-block mb-2">等待开始...</small>
                
                <h6>重大事项变更</h6>
                <div class="d-flex align-items-center mb-2">
                    <span id="badgeImportant" class="badge bg-secondary me-2">Pending</span>
                    <span id="textImportant">等待开始...</span>
                </div>
                
                <h6>运行日志</h6>
                <div class="log-box" id="logBox"></div>
            </div>
        </div>

        <div class="card mb-4" id="resultsCard" style="display:none;">
            <div class="card-header">
                抓取结果概览
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabRegistered">已获许可</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabUnregistered">已注销</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabImportant">重大事项</button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="tabRegistered">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped result-table" id="tableRegistered">
                                <thead><tr><th>许可证号</th><th>公司名称</th><th>业务类型</th><th>生成日期</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabUnregistered">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped result-table" id="tableUnregistered">
                                <thead><tr><th>许可证号</th><th>公司名称</th><th>业务类型</th><th>生成日期</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tabImportant">
                         <div class="table-responsive">
                            <table class="table table-sm table-striped result-table" id="tableImportant">
                                <thead><tr><th>序号</th><th>被许可人名称</th><th>许可文件编号</th><th>许可内容</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pollingInterval = null;

        async function startScraper() {
            const form = document.getElementById('configForm');
            const formData = new FormData(form);
            const dbConfig = {};
            formData.forEach((value, key) => dbConfig[key] = value);
            
            const maxWorkers = document.getElementById('maxWorkers').value;

            try {
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ db_config: dbConfig, max_workers: maxWorkers })
                });
                
                const res = await response.json();
                if (res.status === 'started') {
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('statusMessage').className = 'alert alert-success';
                    document.getElementById('statusMessage').innerText = '任务已启动';
                    document.getElementById('resultsCard').style.display = 'none';
                    startPolling();
                } else {
                    alert('启动失败: ' + res.message);
                }
            } catch (e) {
                alert('请求出错: ' + e);
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(pollStatus, 1000);
        }

        async function pollStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                // Update Logs
                const logBox = document.getElementById('logBox');
                logBox.innerHTML = data.logs.join('<br>');
                logBox.scrollTop = logBox.scrollHeight;

                // Update Status Message
                document.getElementById('statusMessage').innerText = data.message;
                
                // Update Progress Bars
                updateProgress('Registered', data.progress.registered);
                updateProgress('Unregistered', data.progress.unregistered);
                
                // Update Important News Status
                const impStatus = data.progress.important_news;
                const badge = document.getElementById('badgeImportant');
                if (impStatus === 'pending') {
                    badge.className = 'badge bg-secondary me-2';
                    badge.innerText = 'Pending';
                } else if (impStatus === 'running') {
                    badge.className = 'badge bg-primary me-2';
                    badge.innerText = 'Running';
                } else if (impStatus === 'done') {
                    badge.className = 'badge bg-success me-2';
                    badge.innerText = 'Done';
                }

                if (data.status === 'completed' || data.status === 'error') {
                    clearInterval(pollingInterval);
                    document.getElementById('startBtn').disabled = false;
                    if (data.status === 'completed') {
                         document.getElementById('statusMessage').className = 'alert alert-success';
                         document.getElementById('statusMessage').innerText = '任务完成！';
                         renderResults(data.results);
                    } else {
                         document.getElementById('statusMessage').className = 'alert alert-danger';
                         document.getElementById('statusMessage').innerText = '任务出错';
                    }
                }
            } catch (e) {
                console.error('Polling error', e);
            }
        }

        function updateProgress(type, progData) {
            const bar = document.getElementById('prog' + type);
            const text = document.getElementById('text' + type);
            
            if (progData.total > 0) {
                const pct = Math.round((progData.current / progData.total) * 100);
                bar.style.width = pct + '%';
                bar.innerText = pct + '%';
                text.innerText = `进度: ${progData.current}/${progData.total} 页, 已抓取 ${progData.items} 条`;
            } else {
                bar.style.width = '0%';
                text.innerText = '等待中...';
            }
        }

        function renderResults(results) {
            if (!results) return;
            document.getElementById('resultsCard').style.display = 'block';
            
            renderTable('tableRegistered', results.registered, ['许可证号', '公司名称', '业务类型', '生成日期']);
            renderTable('tableUnregistered', results.unregistered, ['许可证号', '公司名称', '业务类型', '生成日期']);
            
            // Important news is list of lists, need special handling or assume standard cols
            // Header: 序号, 被许可人名称（姓名）, 许可文件编号, 许可文件名称, 有效期限, 许可内容, 许可机关
            // Data[0] is header usually, but scraper skips it.
            // Let's just show first few columns
            const impData = results.important_news ? results.important_news.slice(1) : []; // skip header row if present
            
            const tbody = document.querySelector('#tableImportant tbody');
            tbody.innerHTML = '';
            impData.forEach(row => {
                 if (row.length < 4) return;
                 const tr = document.createElement('tr');
                 // Show 0, 1, 2, 5 (Content)
                 tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[5] || ''}</td>`;
                 tbody.appendChild(tr);
            });
        }

        function renderTable(tableId, data, keys) {
            const tbody = document.querySelector('#' + tableId + ' tbody');
            tbody.innerHTML = '';
            if (!data) return;
            
            // Limit to first 100 rows to avoid freezing browser
            data.slice(0, 100).forEach(row => {
                const tr = document.createElement('tr');
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.innerText = row[key] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            if (data.length > 100) {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `<td colspan="${keys.length}" class="text-center text-muted">...还有 ${data.length - 100} 条数据未显示...</td>`;
                 tbody.appendChild(tr);
            }
        }
    </script>
</body>
</html>